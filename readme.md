Telegram-бот «Тайный Санта»
Бот для автоматизации игры «Тайный Санта» в компании с хранением данных в Google Sheets и возможностью рассылок и опросов.

Возможности
Регистрация участников через Telegram (/start, форма с ФИО, отделом и телефоном).

Валидация участников администраторами с подтверждением или отклонением заявки.

Автоматическая жеребьёвка по кольцевой схеме с исключением самодарения.

Личные уведомления каждому участнику о получателе подарка.

Массовые рассылки участникам.

Используемый стек
Python 3.10+.

Telegram-бот: aiogram 3.x.

Google Sheets: gspread + google-auth или google-api-python-client.

Конфигурация: переменные окружения / .env (через python-dotenv).

Логирование: стандартный модуль logging.

Подготовка Google Sheets
Создайте в Google Sheets таблицу минимум с четырьмя листами:

Participants — участники.

Polls — вопросы викторин (ID, вопрос, варианты через «|», индекс правильного ответа, количество очков, статус: draft/active/closed).

PollResponses — ответы участников на викторины (Poll ID, Telegram ID, выбранный вариант, корректность, дата ответа).

Achievements — достижения (если используется геймификация).

Лист Participants должен содержать столбцы в фиксированном порядке.
Не переименовывайте лист и его колонки, иначе бот работать не будет корректно.

Проработка листов Polls и Achievements пока в разработке, возможно будет реализовано к следующему Новому году.

Настройка доступа к Google API
В Google Cloud Console создайте сервисный аккаунт и выдайте ему роль с правами редактирования Google Sheets.

Скачайте JSON-ключ сервисного аккаунта.

Дайте этому аккаунту права «Редактор» на вашу таблицу Google Sheets по e‑mail сервисного аккаунта.

Путь к JSON-файлу или его содержимое в Base64 задайте через переменные окружения (см. ниже).

Переменные окружения
Создайте файл .env или задайте переменные окружения:

BOT_TOKEN — токен Telegram-бота.

ADMIN_IDS — список Telegram ID администраторов (через запятую).

ADMIN_CHAT_ID — ID чата/канала, куда бот добавлен администратором; сюда приходят заявки на валидацию участников, и админы бота могут подтверждать участие.

GSHEET_SPREADSHEET_ID — ID таблицы Google Sheets.

GOOGLE_SERVICE_ACCOUNT_JSON — путь к JSON-ключу сервисного аккаунта.

GSHEET_PARTICIPANTS_SHEET_NAME, GSHEET_POLLS_SHEET_NAME, GSHEET_POLL_RESPONSES_SHEET_NAME, GSHEET_ACHIEVEMENTS_SHEET_NAME — имена листов (по умолчанию: Participants, Polls, PollResponses, Achievements).

GSHEET_REQUEST_TIMEOUT — таймаут HTTP-запросов к Google API в секундах (по умолчанию 10).

GSHEET_MAX_RETRIES — количество повторных попыток при ошибках 429/5xx (по умолчанию 3).

GSHEET_RETRY_BACKOFF — коэффициент экспоненциальной задержки между повторами (по умолчанию 0.5).

GSHEET_PARTICIPANTS_CACHE_TTL — время жизни кэша списка участников в секундах (по умолчанию 10, 0 = выключено).

GSHEET_PARTICIPANTS_BATCH_CHUNK — размер батча при пакетном обновлении строк (по умолчанию 40).

Дополнительные параметры: флаги включения геймификации, интеграции с n8n и т.п. (в разработке).

Установка и запуск
Установите зависимости:

bash
pip install -r requirements.txt
Заполните .env или экспортируйте переменные окружения, затем запустите бота:

bash
python -m bot
(или другой entrypoint в зависимости от структуры проекта.)

Основные команды
Для участников
/start — описание игры и регистрация / обновление данных.

Для администраторов
Список admin_ids задаётся в конфигурации.

/admin — краткое меню администратора.

(Другие админ-команды могут быть добавлены по мере разработки.)

Логика жеребьёвки
В жеребьёвке участвуют только участники с active = TRUE и validated = TRUE.

Бот перемешивает список участников и строит пары по кольцевой схеме: каждый дарит следующему, последний — первому.

Для каждого участника записываются recipient_tg_id, recipient_name, recipient_info и notified = FALSE.

Интеграция с n8n (в разработке)
Бот пишет все данные в Google Sheets, а в дальнейшем планируется интеграция с n8n для:

Рассылок по расписанию и отправки напоминаний через Telegram, email и другие каналы.

Формирования отчётов для администраторов.

И так далее — функциональность будет расширяться по мере развития проекта.
